name: AWS Terraform

on:
  workflow_call:
    inputs:
      terraform_version:
        required: false
        type: string
        default: "1.6.1"
      terraform_command:
        required: true
        type: string
      terraform_workspace:
        required: false
        type: string
      working_directory:
        required: false
        type: string
        default: "/terraform/provisioners/infra/"
      environment:
        required: true
        type: string
        description: "GitHub Environment name"

jobs:
  terraform:
    runs-on: ubuntu-24.04
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Invoke Terraform
        run: |
          docker run \
            -v $(pwd):/app \
            -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY }} \
            -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_KEY }} \
            -e ACTION_WORKING_DIR=/app/${{ inputs.working_directory }} \
            -e ACTION_TERRAFORM_CMD=${{ inputs.terraform_command }} \
            -e ACTION_TERRAFORM_WORKSPACE=${{ inputs.terraform_workspace }} \
            -e BACKEND_region=${{ secrets.AWS_BACKEND_REGION }} \
            -e BACKEND_bucket=${{ secrets.AWS_BACKEND_BUCKET }} \
            -e BACKEND_key=${{ secrets.AWS_BACKEND_KEY }} \
            madpixels/action-terraform:0.0.1_tf${{ inputs.terraform_version }}