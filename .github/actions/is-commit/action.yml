name: Is Commit

description: |
  Determines if the event is a regular push commit (not a PR merge).
  Outputs `proceed=true` if it’s a normal commit, `proceed=false` otherwise.

inputs:
  github_token:
    description: "GitHub token to call the API"
    required: true

outputs:
  proceed:
    description: "‘true’ if this is a normal commit, ‘false’ if it’s a merge‐pull request."

runs:
  using: composite
  steps:
    - name: Initial actor & merge‐check
      id: check
      shell: bash
      run: |
        ACTOR="${{ github.actor }}"
        MSG="${{ github.event.head_commit.message }}"
        echo "Commit actor: $ACTOR"
        echo "Commit message: $MSG"
        # UI-merge/squash always actor=web-flow
        if [[ "$ACTOR" == "web-flow" ]]; then
          echo "proceed=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        # classic "Merge pull request #123…"
        if echo "$MSG" | grep -Eiq "^Merge pull request"; then
          echo "proceed=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        # остальные — пока не ясно, проверим через API
        echo "proceed=maybe" >> $GITHUB_OUTPUT

    - name: Check PR association via GitHub API
      if: steps.check.outputs.proceed == 'maybe'
      id: prcheck
      shell: bash
      run: |
        SHA="${{ github.event.head_commit.id }}"
        # узнаём, есть ли у этого SHA открытые PR
        prs=$(curl -s \
          -H "Accept: application/vnd.github.groot-preview+json" \
          -H "Authorization: Bearer ${{ inputs.github_token }}" \
          https://api.github.com/repos/${{ github.repository }}/commits/$SHA/pulls)
        count=$(echo "$prs" | jq 'length')
        if [ "$count" -gt 0 ]; then
          echo "proceed=false" >> $GITHUB_OUTPUT
        else
          echo "proceed=true"  >> $GITHUB_OUTPUT
        fi